<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div class="CenterDiv MainContainer">
      <h1>{{level.name}}</h1>

      {% include "messages.html" %}

      <!-- Level settings form -->
      <!-- TODO -->
      <form action="" method="POST">
        <table border="1">
          <tr>
            <th>Name</th>
            <th>Width</th>
            <th>Height</th>
          </tr>
          <tr>
            <td><input value="{{level.name}}" name="name" type="text"></td>
            <td><input value="{{level.width}}" name="width" type="text"></td>
            <td><input value="{{level.height}}" name="height" type="text"></td>
          </tr>
        </table>
        <input type="submit" value="Update">
      </form>

      <script>
        function drawFloorplan() {
          const floorplanImage = document.querySelector("#floorplanImage");
          const context = levelOverviewCanvas.getContext("2d");
          context.drawImage(floorplanImage, 0, 0);
        }
      </script>
      <img src="/{{level.getFloorplanPath()}}" style="display:none" id="floorplanImage" onload="drawFloorplan();" />
      <img style="display:none" id="tilesetImage" onload="updateTileSelectionCanvas();"/>

      <!-- Level overview -->
      <canvas style="border:1px solid black;" id="levelOverviewCanvas" width="{{level.width}}" height="{{level.height}}"></canvas>

      <!-- Tileset/tile selector -->
      <div style="float:right;">
        <button onclick="prevImage();">◀ Prev</button><br>
        <button onclick="nextImage();">Next ▶</button><br>
        <button onclick="fillWithTile();">Fill</button>
        <div id="container" style="position:relative;">
          <canvas style="position:absolute; right:0; top:0; z-index:2;" id="overlayCanvas">
          </canvas>
          <canvas style="position:absolute; right:0; top:0; z-index:1;" id="tileSelectionCanvas">
          </canvas>
        </div>
      </div>

      <!-- Save Button -->
      <br>
      <button onclick="saveFloorplanImage();">Save Floorplan</button>
    </div>

    <script src="/src/Keys.js"></script>
    <script src="/src/lib/jquery.min.js"></script>
    <script>
      "use strict;"

      let selectionX = 0;
      let selectionY = 0;
      let tilesetIndex = 0;
      let tileSize = 32;
      const tilesetImage = document.querySelector("#tilesetImage");
      const tileSelectionCanvas = document.querySelector("#tileSelectionCanvas");
      const levelOverviewCanvas = document.querySelector("#levelOverviewCanvas");
      const overlayCanvas = document.querySelector("#overlayCanvas");
      const container = document.querySelector("#container");
      const tilesetURLs = [];
      {% for tileset in tilesets %}
        tilesetURLs.push('/{{tileset.path}}');
      {% endfor %}

      function saveFloorplanImage() {
        const dataURL = levelOverviewCanvas.toDataURL();

        $.ajax({
          type: 'POST',
          url: '/games/{{game.ID}}/levels/{{level.ID}}/floorplan/save',
          data: {
            imgBase64: dataURL
          }
        })
      }

      function snapToGrid(value, gridSize) {
        return Math.floor(value / gridSize) * gridSize;
      }

      levelOverviewCanvas.onclick = function drawTile(e, x, y) {
        let dx, dy;
        if (e) {
          dx = snapToGrid(e.pageX - this.offsetLeft, tileSize);
          dy = snapToGrid(e.pageY - this.offsetTop, tileSize);
        }
        else {
          dx = x;
          dy = y;
        }
        const context = levelOverviewCanvas.getContext("2d");

        context.beginPath();
        if (keysDown[CTRL]) {
          context.clearRect(dx, dy, tileSize, tileSize);
        }
        else {
          context.drawImage(tileSelectionCanvas, selectionX, selectionY, tileSize,
          tileSize, dx, dy, tileSize, tileSize);
        }
        context.stroke();
      }

      function drawSelection() {
        const context = overlayCanvas.getContext("2d");

        context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        context.strokeStyle="red";
        context.beginPath();
        context.rect(selectionX, selectionY, tileSize, tileSize);
        context.stroke();
      }

      function fillWithTile() {
        for (let i = 0; i < levelOverviewCanvas.width; i += tileSize) {
          for (let j = 0; j < levelOverviewCanvas.height; j += tileSize) {
            levelOverviewCanvas.onclick(null, i, j);
          }
        }
      }

      overlayCanvas.onclick = function setSelection(e) {
        selectionX = snapToGrid(e.pageX - container.offsetLeft - this.offsetLeft, tileSize);
        selectionY = snapToGrid(e.pageY - container.offsetTop - this.offsetTop, tileSize);
        drawSelection();
      }

      function updateTileSelectionCanvas() {
        // Resizes the tile selection canvas
        const context = tileSelectionCanvas.getContext("2d");

        tileSelectionCanvas.width = tilesetImage.width;
        tileSelectionCanvas.height = tilesetImage.height;
        overlayCanvas.width = tileSelectionCanvas.width;
        overlayCanvas.height = tileSelectionCanvas.height;


        context.beginPath();
        context.drawImage(tilesetImage, 0, 0);
        context.stroke();
      }

      function updateImage() {
        // Displays a new image
        if (tilesetURLs.length < 1) {
          return;
        }
        tilesetImage.src = tilesetURLs[tilesetIndex];
      }
      updateImage();

      function prevImage() {
        tilesetIndex--;
        if (tilesetIndex < 0) {
          tilesetIndex = tilesetURLs.length - 1;
        }
        updateImage();
      }

      function nextImage() {
        tilesetIndex++;
        if (tilesetIndex > tilesetURLs.length - 1) {
          tilesetIndex = 0;
        }
        updateImage();
      }
    </script>
  </body>
</html>